"use strict";(self.webpackChunkblog=self.webpackChunkblog||[]).push([["7340"],{8182:function(e,n,r){r.r(n),r.d(n,{default:()=>o});var i=r(52676),s=r(40453),c=r(20713);function t(e){let n=Object.assign({h1:"h1",a:"a",h2:"h2",p:"p",code:"code",strong:"strong",pre:"pre",blockquote:"blockquote",img:"img",h3:"h3",ul:"ul",li:"li",hr:"hr"},(0,s.ah)(),e.components);return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)(n.h1,{id:"还在用开发者工具上传小程序-快来试试-miniprogram-ci-提效摸鱼",children:[(0,i.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#还在用开发者工具上传小程序-快来试试-miniprogram-ci-提效摸鱼",children:"#"}),"还在用开发者工具上传小程序? 快来试试 miniprogram-ci 提效摸鱼"]}),"\n",(0,i.jsx)(c.Z,{defaultLocale:"zh-CN"}),"\n",(0,i.jsxs)(n.h2,{id:"1-前言",children:[(0,i.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#1-前言",children:"#"}),"1. 前言"]}),"\n",(0,i.jsxs)(n.p,{children:["大家好，我是",(0,i.jsx)(n.a,{href:"https://ruochuan12.github.io",rel:"noopener noreferrer",target:"_blank",children:"若川"}),"。我倾力持续组织了一年",(0,i.jsx)(n.a,{href:"https://juejin.cn/post/7079706017579139102",rel:"noopener noreferrer",target:"_blank",children:"每周大家一起学习200行左右的源码共读活动"}),"，感兴趣的可以",(0,i.jsxs)(n.a,{href:"https://juejin.cn/pin/7217386885793595453",rel:"noopener noreferrer",target:"_blank",children:["点此扫码加我微信 ",(0,i.jsx)(n.code,{children:"ruochuan02"})," 参与"]}),"。另外，想学源码，极力推荐关注我写的专栏",(0,i.jsx)(n.a,{href:"https://juejin.cn/column/6960551178908205093",rel:"noopener noreferrer",target:"_blank",children:"《学习源码整体架构系列》"}),"，目前是掘金关注人数（4.3k+人）第一的专栏，写有20余篇源码文章。"]}),"\n",(0,i.jsxs)(n.h2,{id:"2-前情回顾",children:[(0,i.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#2-前情回顾",children:"#"}),"2. 前情回顾"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsxs)(n.strong,{children:["注意：文章是基于 ",(0,i.jsx)(n.a,{href:"https://github.com/ruochuan12/mini-ci/tree/0.7.0",rel:"noopener noreferrer",target:"_blank",children:(0,i.jsx)(n.code,{children:"tag v0.7.0"})})," 撰写。目前工具是 ",(0,i.jsx)(n.code,{children:"0.12.0"})," 版本，后续 ",(0,i.jsx)(n.code,{children:"mini-ci"})," 会持续更新，文章应该暂时不会更新"]}),"。"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.a,{href:"https://github.com/ruochuan12/mini-ci.git",rel:"noopener noreferrer",target:"_blank",children:"本文提到的工具 mini-ci 已开源，求个 star^_^"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"# 可全局安装\nnpm i @ruochuan/mini-ci -g\nmini-ci -h\n# 也可以不全局安装\nnpx @ruochuan/mini-ci -h\n# 查看帮助信息，或者查看文档：https://github.com/ruochuan12/mini-ci.git，\n"})}),"\n",(0,i.jsx)(n.p,{children:"估计有很多开发小程序的同学，还在使用微信开发者工具上传小程序。如果你是，那么这篇文章非常适合你。如果不是，同样也很适合你。"}),"\n",(0,i.jsxs)(n.p,{children:["早在 2021 年 08 月，我写过一篇文章 ",(0,i.jsx)(n.a,{href:"https://juejin.cn/post/6997943192851054606",rel:"noopener noreferrer",target:"_blank",children:"Vue 3.2 发布了，那尤雨溪是怎么发布 Vue.js 的？"})]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"Vue 2.7"})," 如何发布跟",(0,i.jsx)(n.code,{children:"Vue 3.2"}),"这篇文章类似，所以就不赘述了。"]}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"vuejs"}),"发布的文件很多代码我们可以直接复制粘贴修改，优化我们自己发布的流程。比如写小程序，相对可能发布频繁，完全可以使用这套代码，配合",(0,i.jsx)(n.a,{href:"https://developers.weixin.qq.com/miniprogram/dev/devtools/ci.html",title:"miniprogram-ci",rel:"noopener noreferrer",target:"_blank",children:"miniprogram-ci"}),"，再加上一些自定义，加以优化。"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"于是今天我们来开发这样的脚手架工具。"}),"\n",(0,i.jsx)(n.p,{children:"看完本文，你将学到："}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"1. 如何利用 release-it 提升版本号，自动打 tag，生成 changelog 等\n2. npm init 原理\n3. 如何写一个脚手架工具\n - 如何解析 Nodejs 命令行参数 minimist\n - 如何选择单选、多选 enquirer(prompt, MultiSelect)\n - 等等\n"})}),"\n",(0,i.jsx)(n.p,{children:"先看看最终开发的效果。"}),"\n",(0,i.jsx)(n.p,{children:"支持的功能"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{src:"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/600f4161b25c4d62b47c2fffb8f267fd~tplv-k3u1fbpfcp-watermark.image?",alt:"支持的功能"})}),"\n",(0,i.jsx)(n.p,{children:"显示帮助信息"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{src:"https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8bb61b337b4a4065ae669ba3738c8d53~tplv-k3u1fbpfcp-watermark.image?",alt:"显示帮助信息"})}),"\n",(0,i.jsx)(n.p,{children:"上传效果"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{src:"https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3fdedad23161405b9381daf272443f1f~tplv-k3u1fbpfcp-watermark.image?",alt:"上传效果"})}),"\n",(0,i.jsxs)(n.h2,{id:"3-关于为啥要开发这样的工具",children:[(0,i.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#3-关于为啥要开发这样的工具",children:"#"}),"3. 关于为啥要开发这样的工具"]}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsxs)(n.p,{children:["关于小程序 ",(0,i.jsx)(n.code,{children:"ci"})," 上传，再分享两篇文章。"]}),"\n"]}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.a,{href:"https://help.coding.net/docs/best-practices/ci/1minute/wechat-mini-program.html",rel:"noopener noreferrer",target:"_blank",children:"基于 CI 实现微信小程序的持续构建"})}),"\n"]}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.a,{href:"https://www.yuque.com/jinxuanzheng/gvhmm5/uy4qu9#8yQ8M",rel:"noopener noreferrer",target:"_blank",children:"小打卡小程序自动化构建及发布的工程化实践"})," 虽然文章里不是最新的 ",(0,i.jsx)(n.code,{children:"miniprogram-ci"}),"，但这篇场景写得比较全面。"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"接着，我们先来看看 miniprogram-ci 官方文档。"}),"\n",(0,i.jsxs)(n.h2,{id:"4-miniprogram-ci-官方文档",children:[(0,i.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#4-miniprogram-ci-官方文档",children:"#"}),"4. miniprogram-ci 官方文档"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.a,{href:"https://developers.weixin.qq.com/miniprogram/dev/devtools/ci.html",rel:"noopener noreferrer",target:"_blank",children:"miniprogram-ci 文档"})}),"\n",(0,i.jsxs)(n.h3,{id:"41-上传",children:[(0,i.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#41-上传",children:"#"}),"4.1 上传"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-js",children:"const ci = require('miniprogram-ci');\n(async () => {\n const project = new ci.Project({\n  appid: 'wxsomeappid',\n  type: 'miniProgram',\n  projectPath: 'the/project/path',\n  privateKeyPath: 'the/path/to/privatekey',\n  ignores: ['node_modules/**/*'],\n });\n const uploadResult = await ci.upload({\n  project,\n  version: '1.1.1',\n  desc: 'hello',\n  setting: {\n   es6: true,\n  },\n  onProgressUpdate: console.log,\n });\n console.log(uploadResult);\n})();\n"})}),"\n",(0,i.jsxs)(n.h3,{id:"42-预览",children:[(0,i.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#42-预览",children:"#"}),"4.2 预览"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-js",children:"const ci = require('miniprogram-ci');\n(async () => {\n const project = new ci.Project({\n  appid: 'wxsomeappid',\n  type: 'miniProgram',\n  projectPath: 'the/project/path',\n  privateKeyPath: 'the/path/to/privatekey',\n  ignores: ['node_modules/**/*'],\n });\n const previewResult = await ci.preview({\n  project,\n  desc: 'hello', // 此备注将显示在“小程序助手”开发版列表中\n  setting: {\n   es6: true,\n  },\n  qrcodeFormat: 'image',\n  qrcodeOutputDest: '/path/to/qrcode/file/destination.jpg',\n  onProgressUpdate: console.log,\n  // pagePath: 'pages/index/index', // 预览页面\n  // searchQuery: 'a=1&b=2',  // 预览参数 [注意!]这里的`&`字符在命令行中应写成转义字符`\\&`\n });\n console.log(previewResult);\n})();\n"})}),"\n",(0,i.jsxs)(n.h2,{id:"5-taro-小程序插件-tarojsplugin-mini-ci",children:[(0,i.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#5-taro-小程序插件-tarojsplugin-mini-ci",children:"#"}),"5. Taro 小程序插件 @tarojs/plugin-mini-ci"]}),"\n",(0,i.jsxs)(n.p,{children:["如果使用 ",(0,i.jsx)(n.code,{children:"Taro"})," 开发的小程序，可以直接使用。"]}),"\n",(0,i.jsx)(n.p,{children:"具体如何使用参考文档，我在本文中就不赘述了。"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.a,{href:"https://taro-docs.jd.com/taro/docs/plugin-mini-ci/",rel:"noopener noreferrer",target:"_blank",children:"小程序持续集成 @tarojs/plugin-mini-ci"})}),"\n",(0,i.jsxs)(n.p,{children:["我组织的",(0,i.jsx)(n.a,{href:"https://juejin.cn/post/7082662027143053342",rel:"noopener noreferrer",target:"_blank",children:"源码共读第 30 期"}),"读的就是这个插件，非常值得学习。",(0,i.jsx)(n.a,{href:"https://juejin.cn/post/7089819849257385997",rel:"noopener noreferrer",target:"_blank",children:"@tarojs/plugin-mini-ci 源码解读可以参考 @NewName 的源码文章"})]}),"\n",(0,i.jsx)(n.p,{children:"我体验下来的感觉有以下几点可以优化。"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"不支持指定机器人"}),"\n",(0,i.jsx)(n.li,{children:"不支持不打包时上传"}),"\n",(0,i.jsx)(n.li,{children:"不支持官方提供的更多配置"}),"\n",(0,i.jsx)(n.li,{children:"不支持选择多个小程序批量上传等等"}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["如果有时间我可能给 ",(0,i.jsx)(n.code,{children:"Taro"})," 提 ",(0,i.jsx)(n.code,{children:"PR"}),"，当然不一定会被合并。"]}),"\n",(0,i.jsxs)(n.h2,{id:"6-uni-app-好像没有提供类似的插件",children:[(0,i.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#6-uni-app-好像没有提供类似的插件",children:"#"}),"6. uni-app 好像没有提供类似的插件"]}),"\n",(0,i.jsx)(n.p,{children:"uni-app 好像没有提供类似的插件。需要自己动手，丰衣足食。"}),"\n",(0,i.jsxs)(n.h2,{id:"7-release-it-自动提升版本打-tag生成-changelog-等",children:[(0,i.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#7-release-it-自动提升版本打-tag生成-changelog-等",children:"#"}),"7. release-it 自动提升版本、打 tag、生成 changelog 等"]}),"\n",(0,i.jsxs)(n.p,{children:["于是我们自己动手，丰衣足食，写一个工具解决上面提到的问题，",(0,i.jsxs)(n.strong,{children:["支持 ",(0,i.jsx)(n.code,{children:"Taro"})," 打包后的小程序和 ",(0,i.jsx)(n.code,{children:"uni-app"})," 打包后的，还有原生小程序上传和预览"]}),"。"]}),"\n",(0,i.jsx)(n.p,{children:"开发小工具之前，先介绍一些好用的工具。"}),"\n",(0,i.jsxs)(n.p,{children:["据说很多小伙伴的项目，没有打 ",(0,i.jsx)(n.code,{children:"tag"}),"、没有版本的概念，没有生成 ",(0,i.jsx)(n.code,{children:"changelog"}),"，没有配置 ",(0,i.jsx)(n.code,{children:"eslint"}),"、",(0,i.jsx)(n.code,{children:"prettier"}),"，没有 ",(0,i.jsx)(n.code,{children:"commit"})," 等规范。"]}),"\n",(0,i.jsxs)(n.p,{children:["这些其实不难，",(0,i.jsx)(n.code,{children:"commit"})," 规范一般简单做法是安装 ",(0,i.jsx)(n.code,{children:"npm i git-cz -D"}),"，\n在",(0,i.jsx)(n.code,{children:"package.json"})," 中加入如下脚本。"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'{\n "scripts": {\n  "commit": "git-cz"\n }\n}\n'})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"git"})," 提交时使用 ",(0,i.jsx)(n.code,{children:"npm run commit"})," 即可，其他就不赘述了。"]}),"\n",(0,i.jsxs)(n.p,{children:["release-it，自动提升版本号，自动打 ",(0,i.jsx)(n.code,{children:"tag"}),"，生成 ",(0,i.jsx)(n.code,{children:"changelog"})," 等"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.a,{href:"https://github.com/release-it/release-it",rel:"noopener noreferrer",target:"_blank",children:"release-it 官网仓库"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"npm init release-it\n# 选择 .release-it.json 用下面的配置，复制粘贴到 .release-it.json 中。\n# 再安装 changelog 插件\nnpm i @release-it/conventional-changelog -D\n"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'{\n "github": {\n  "release": false\n },\n "git": {\n  "commitMessage": "release: v${version}"\n },\n "npm": {\n  "publish": false\n },\n "hooks": {\n  "after:bump": "echo 更新版本成功"\n },\n "plugins": {\n  "@release-it/conventional-changelog": {\n   "preset": "angular",\n   "infile": "CHANGELOG.md"\n  }\n }\n}\n'})}),"\n",(0,i.jsxs)(n.p,{children:["这样配置后，可以 ",(0,i.jsx)(n.code,{children:"npm run release"})," 执行 ",(0,i.jsx)(n.code,{children:"release-it"})," 版本。\n还支持 hooks 钩子，比如提升版本号后",(0,i.jsx)(n.code,{children:'"after:bump": "echo 更新版本成功"'}),"，更多功能可以查看",(0,i.jsx)(n.a,{href:"https://github.com/release-it/release-it",rel:"noopener noreferrer",target:"_blank",children:"release-it 官网仓库"}),"。"]}),"\n",(0,i.jsxs)(n.h3,{id:"71-npm-init-release-it-原理",children:[(0,i.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#71-npm-init-release-it-原理",children:"#"}),"7.1 npm init release-it 原理"]}),"\n",(0,i.jsxs)(n.p,{children:["为啥 ",(0,i.jsx)(n.code,{children:"npm init"})," 也可以直接初始化一个项目，带着疑问，我们翻看 npm 文档。"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.a,{href:"https://docs.npmjs.com/cli/v6/commands/npm-init",rel:"noopener noreferrer",target:"_blank",children:(0,i.jsx)(n.code,{children:"npm init"})})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"npm init"})," 用法："]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"npm init [--force|-f|--yes|-y|--scope]\nnpm init <@scope> (same as `npx <@scope>/create`)\nnpm init [<@scope>/]<name> (same as `npx [<@scope>/]create-<name>`)\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"npm init <initializer>"})," 时转换成 ",(0,i.jsx)(n.code,{children:"npx"})," 命令："]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"npm init foo -> npx create-foo\nnpm init @usr/foo -> npx @usr/create-foo\nnpm init @usr -> npx @usr/create\n"})}),"\n",(0,i.jsx)(n.p,{children:"看完文档，我们也就理解了："}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsxs)(n.strong,{children:["运行 ",(0,i.jsx)(n.code,{children:"npm init release-it"})," => 相当于 ",(0,i.jsx)(n.code,{children:"npx create-release-it"})]})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.a,{href:"https://github.com/release-it/create-release-it",rel:"noopener noreferrer",target:"_blank",children:"create-release-it"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"npm init release-it"})," 原理其实就是 ",(0,i.jsx)(n.code,{children:"npx create-release-it"}),"\n选择一些配置，生成 ",(0,i.jsx)(n.code,{children:".release-it.json"})," 或者 ",(0,i.jsx)(n.code,{children:"package.json"})," 的 ",(0,i.jsx)(n.code,{children:"release-it"})," 配置。"]}),"\n",(0,i.jsxs)(n.p,{children:["再写入命令",(0,i.jsx)(n.code,{children:"release"})," 配置到 ",(0,i.jsx)(n.code,{children:"package.json"}),"。"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'{\n "scripts": {\n  "release": "release-it"\n }\n}\n'})}),"\n",(0,i.jsxs)(n.p,{children:["最后执行 ",(0,i.jsx)(n.code,{children:"npm install release-it --save-dev"}),"\n也就是源码里的 ",(0,i.jsx)(n.code,{children:"await execa('npm', ['install', 'release-it', '--save-dev'], { stdio: 'inherit' });"}),"。"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.a,{href:"https://github.com/release-it/create-release-it/blob/master/index.js#L120",rel:"noopener noreferrer",target:"_blank",children:"这行源码位置"})}),"\n",(0,i.jsxs)(n.h2,{id:"8-小程序上传工具实现主流程",children:[(0,i.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#8-小程序上传工具实现主流程",children:"#"}),"8. 小程序上传工具实现主流程"]}),"\n",(0,i.jsx)(n.p,{children:"需要支持多选，那肯定得遍历数组。"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-js",children:"// 代码只是关键代码，完整的可以查看 https://github.com/ruochuan12/mini-ci/blob/0.7.0/src/index.js\n(async () => {\n for (const mpConfigItem of mpConfigList) {\n  try {\n   const res = await main({});\n  } catch (err) {\n   console.log('执行失败', err);\n  }\n }\n})();\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"main"})," 函数"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-js",children:"const { green, bold } = require('kolorist');\nconst step = (msg) => console.log(bold(green(`[step] ${msg}`)));\nasync function main(options = {}) {\n const project = new ci.Project(lastProjectOptions);\n if (upload) {\n  step('开始上传小程序...');\n  const uploadResult = await ci.upload(lastUploadOptions);\n  console.log('uploadResult', uploadResult);\n }\n if (preview) {\n  step('开始生成预览二维码...');\n  const previewResult = await ci.preview(lastPreviewOptions);\n  console.log('previewResult', previewResult);\n }\n}\n"})}),"\n",(0,i.jsxs)(n.h3,{id:"81-添加功能支持指定参数",children:[(0,i.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#81-添加功能支持指定参数",children:"#"}),"8.1 添加功能支持指定参数"]}),"\n",(0,i.jsxs)(n.p,{children:["使用 ",(0,i.jsx)(n.a,{href:"https://github.com/minimist/minimist",rel:"noopener noreferrer",target:"_blank",children:"minimist"})," 解析命令行参数。"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-js",children:"const getParams = () => {\n const params = process.argv.slice(2);\n const paramsDefault = {\n  default: {\n   robot: 1,\n   preview: false,\n   upload: false,\n   // 空跑，不执行\n   dry: false,\n   // 根据配置，单选还是多选来上传小程序\n   useSelect: false,\n   useMultiSelect: false,\n   help: false,\n   version: false,\n  },\n  alias: {\n   u: 'upload',\n   r: 'robot',\n   v: 'version',\n   d: 'dry',\n   s: 'useSelect',\n   m: 'useMultiSelect',\n   p: 'preview',\n   h: 'help',\n  },\n };\n return require('minimist')(params, paramsDefault);\n};\n\nmodule.exports = {\n getParams,\n};\n"})}),"\n",(0,i.jsxs)(n.h3,{id:"82-支持读取项目的packagejson-的version也支持读取自定义version",children:[(0,i.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#82-支持读取项目的packagejson-的version也支持读取自定义version",children:"#"}),"8.2 支持读取项目的",(0,i.jsx)(n.code,{children:"package.json"})," 的",(0,i.jsx)(n.code,{children:"version"}),"，也支持读取自定义",(0,i.jsx)(n.code,{children:"version"})]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.a,{href:"https://github.com/marvinhagemeister/kolorist",rel:"noopener noreferrer",target:"_blank",children:"kolorist"})," 颜色输出。"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-js",children:"const { red, bold } = require('kolorist');\nconst getVersion = () => {\n let version;\n try {\n  version = require(`${packageJsonPath}/package.json`).version;\n } catch (e) {\n  console.log(e);\n  console.log(\n   red(\n    bold(\n     '未设置 version , 并且未设置 package.json 路径，无法读取 version',\n    ),\n   ),\n  );\n }\n return version;\n};\n\nmodule.exports = {\n getVersion,\n};\n"})}),"\n",(0,i.jsxs)(n.h3,{id:"83-版本描述-支持指定-git-commit-hash-和作者",children:[(0,i.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#83-版本描述-支持指定-git-commit-hash-和作者",children:"#"}),"8.3 版本描述 支持指定 git commit hash 和作者"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"git rev-parse --short HEAD"})," 读取 ",(0,i.jsx)(n.code,{children:"git"})," 仓库最近一次的 ",(0,i.jsx)(n.code,{children:"commit hash"}),"。"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"parse-git-config"})," 可以读取 ",(0,i.jsx)(n.code,{children:".git/config"})," 配置。"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-js",children:"// const path = require('path');\nconst { execSync } = require('child_process');\nconst parseGitConfig = require('parse-git-config');\nconst getDesc = (projectPath, version) => {\n // 获取最新 git 记录 7位的 commit hash\n let gitCommitHash = 'git commit hash 为空';\n try {\n  gitCommitHash = execSync('git rev-parse --short HEAD', {\n   cwd: projectPath,\n  })\n   .toString()\n   .trim();\n } catch (e) {\n  console.warn('获取 git commit hash 失败');\n  console.warn(e);\n }\n\n // 获取项目的git仓库的 user.name\n let userName = '默认';\n try {\n  const {\n   user: { name = '默认' },\n  } = parseGitConfig.sync({\n   cwd: projectPath,\n   path: '.git/config',\n  });\n  userName = name;\n } catch (e) {\n  console.warn('获取 .git/config user.name 失败');\n  console.warn(e);\n }\n\n const desc = `v${version} - ${gitCommitHash} - by@${userName}`;\n return desc;\n};\n\nmodule.exports = getDesc;\n"})}),"\n",(0,i.jsxs)(n.h3,{id:"84-读取配置-wxconfigjs-配置更推荐",children:[(0,i.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#84-读取配置-wxconfigjs-配置更推荐",children:"#"}),"8.4 读取配置 wx.config.js 配置（更推荐）"]}),"\n",(0,i.jsxs)(n.p,{children:["当前也支持读取 ",(0,i.jsx)(n.code,{children:".env"})," 配置。读取 ",(0,i.jsx)(n.code,{children:".env"})," 配置，可以采用 ",(0,i.jsx)(n.a,{href:"https://github.com/motdotla/dotenv",rel:"noopener noreferrer",target:"_blank",children:(0,i.jsx)(n.code,{children:"dotenv"})}),"。关于 dotenv 的原理，可以看我之前写过的文章",(0,i.jsx)(n.a,{href:"https://juejin.cn/post/7045057475845816357",rel:"noopener noreferrer",target:"_blank",children:"面试官：项目中常用的 .env 文件原理是什么？如何实现？"})]}),"\n",(0,i.jsxs)(n.p,{children:["但 ",(0,i.jsx)(n.code,{children:"wx.config.js"})," 可以配置更多东西而且更灵活。所以更推荐。"]}),"\n",(0,i.jsxs)(n.p,{children:["感兴趣的可以研究 ",(0,i.jsx)(n.code,{children:"vue-cli"})," 是如何读取 ",(0,i.jsx)(n.code,{children:"vue.config.js"})," 配置的。围绕工作相关的学习，往往收益更大。"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-js",children:"// 读取 wx.config.js 配置\nconst loadWxconfig = (cwd) => {\n try {\n  return require(path.join(cwd, 'wx.config.js'));\n } catch (e) {\n  return {\n   error: '未配置 wx.config.js 文件',\n  };\n }\n};\n\nconst parseEnv = () => {\n const cwd = process.cwd();\n\n let parsed = {};\n let wxconfig = loadWxconfig(cwd);\n if (wxconfig.error) {\n  let dotenvResult = require('dotenv').config({\n   path: path.join(cwd, './.env'),\n  });\n\n  parsed = dotenvResult.parsed;\n  if (dotenvResult.error) {\n   throw error;\n  }\n } else {\n  parsed = wxconfig;\n }\n // 代码有省略\n};\n"})}),"\n",(0,i.jsxs)(n.h3,{id:"85-支持选择多个小程序",children:[(0,i.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#85-支持选择多个小程序",children:"#"}),"8.5 支持选择多个小程序"]}),"\n",(0,i.jsxs)(n.p,{children:["我们可以用 ",(0,i.jsx)(n.a,{href:"https://github.com/enquirer/enquirer",rel:"noopener noreferrer",target:"_blank",children:"enquirer"})," 来实现单选或者多选的功能。以下只是关键代码。\n完整代码可以查看 ",(0,i.jsx)(n.a,{href:"https://github.com/ruochuan12/mini-ci/blob/0.7.0/src/utils/getConfig.js",rel:"noopener noreferrer",target:"_blank",children:"mini-ci/src/utils/getConfig.js 文件"}),"。"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-js",children:"// 只是关键代码\nconst { prompt, MultiSelect } = require('enquirer');\nconst configPathList = fs.readdirSync(configPath);\nconst configPathListJson = configPathList.map((el) => {\n return require(`${configPath}/${el}`);\n});\nconst { name } = await prompt({\n type: 'select',\n name: 'name',\n message: '请选择一个小程序配置',\n choices: configPathListJson,\n});\nresult = configPathListJson.filter((el) => el.name === name);\nreturn result;\n"})}),"\n",(0,i.jsxs)(n.h3,{id:"86-支持多个批量上传",children:[(0,i.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#86-支持多个批量上传",children:"#"}),"8.6 支持多个批量上传"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-js",children:"// 只是关键代码\nconst { prompt, MultiSelect } = require('enquirer');\nconst configPathList = fs.readdirSync(configPath);\nconst configPathListJson = configPathList.map((el) => {\n return require(`${configPath}/${el}`);\n});\nconst multiSelectPrompt = new MultiSelect({\n name: 'value',\n message: '可选择多个小程序配置',\n limit: 7,\n choices: configPathListJson,\n});\n\ntry {\n const answer = await multiSelectPrompt.run();\n console.log('Answer:', answer);\n result = configPathListJson.filter((el) => answer.includes(el.name));\n return result;\n} catch (err) {\n console.log('您已经取消');\n console.log(err);\n process.exit(1);\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"后续可能接入 CI/CD、接入邮件提醒、接入钉钉、支持可视化操作等等"})}),"\n",(0,i.jsxs)(n.h3,{id:"87-更多如何使用可以参考文档",children:[(0,i.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#87-更多如何使用可以参考文档",children:"#"}),"8.7 更多如何使用可以参考文档"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"# 全局安装 mini-ci 工具，也可以不全局安装\nnpm i @ruochuan/mini-ci -g\nmini-ci -h\nnpx @ruochuan/mini-ci -h\n# 文档：https://github.com/ruochuan12/mini-ci.git\n# 克隆腾讯开源的电商小程序\ngit clone https://github.com/ruochuan12/tdesign-miniprogram-starter-retail.git\n# 切到分支 feature/release-it\ngit checkout feature/release-it\n"})}),"\n",(0,i.jsxs)(n.p,{children:["可以克隆我的另外一个小程序（腾讯开源的电商小程序）。比如 ",(0,i.jsx)(n.code,{children:"projects"})," 中。"]}),"\n",(0,i.jsxs)(n.p,{children:["按照",(0,i.jsx)(n.a,{href:"https://developers.weixin.qq.com/miniprogram/dev/devtools/ci.html",rel:"noopener noreferrer",target:"_blank",children:"微信小程序文档"}),"配置小程序密钥等，这样就能上传和预览了。如果没有微信小程序，可以自行免费开通个人的",(0,i.jsx)(n.a,{href:"https://mp.weixin.qq.com/",rel:"noopener noreferrer",target:"_blank",children:"微信小程序"}),"。"]}),"\n",(0,i.jsxs)(n.h2,{id:"9-总结",children:[(0,i.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#9-总结",children:"#"}),"9. 总结"]}),"\n",(0,i.jsx)(n.p,{children:"通过本文的学习，我们知道了以下知识。"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"1. 如何利用 release-it 提升版本号，自动打 tag，生成 changelog 等\n2. npm init 原理\n3. 如何写一个脚手架工具\n - 如何解析 Nodejs 命令行参数 minimist\n - 如何选择单选、多选 enquirer(prompt, MultiSelect)\n - 等等\n"})}),"\n",(0,i.jsx)(n.p,{children:"我相信大家也能够自己动手实现公司类似要求的脚手架工具，减少发版时间，降本提效。"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.a,{href:"https://github.com/ruochuan12/mini-ci.git",rel:"noopener noreferrer",target:"_blank",children:"本文提到的工具 mini-ci 已开源，求个 star^_^"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"# 可全局安装\nnpm i @ruochuan/mini-ci -g\nmini-ci -h\n# 也可以不全局安装\nnpx @ruochuan/mini-ci -h\n# 查看帮助信息，或者查看文档：https://github.com/ruochuan12/mini-ci.git，\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsxs)(n.strong,{children:["注意：文章是基于 ",(0,i.jsx)(n.a,{href:"https://github.com/ruochuan12/mini-ci/tree/0.7.0",rel:"noopener noreferrer",target:"_blank",children:(0,i.jsx)(n.code,{children:"tag v0.7.0"})})," 撰写。目前工具是 ",(0,i.jsx)(n.code,{children:"0.12.0"})," 版本，后续 ",(0,i.jsx)(n.code,{children:"mini-ci"})," 会持续更新，文章应该暂时不会更新"]}),"。"]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsxs)(n.p,{children:["最后可以持续关注我",(0,i.jsx)(n.a,{href:"https://juejin.cn/user/1415826704971918",rel:"noopener noreferrer",target:"_blank",children:"@若川"}),"。我倾力持续组织了一年",(0,i.jsx)(n.a,{href:"https://juejin.cn/post/7079706017579139102",rel:"noopener noreferrer",target:"_blank",children:"每周大家一起学习200行左右的源码共读活动"}),"，感兴趣的可以",(0,i.jsxs)(n.a,{href:"https://juejin.cn/pin/7217386885793595453",rel:"noopener noreferrer",target:"_blank",children:["点此扫码加我微信 ",(0,i.jsx)(n.code,{children:"ruochuan02"})," 参与"]}),"。"]}),"\n",(0,i.jsxs)(n.p,{children:["另外，想学源码，极力推荐关注我写的专栏",(0,i.jsx)(n.a,{href:"https://juejin.cn/column/6960551178908205093",rel:"noopener noreferrer",target:"_blank",children:"《学习源码整体架构系列》"}),"，目前是掘金关注人数（4.2k+人）第一的专栏，写有20余篇源码文章。包含",(0,i.jsx)(n.code,{children:"jQuery"}),"、",(0,i.jsx)(n.code,{children:"underscore"}),"、",(0,i.jsx)(n.code,{children:"lodash"}),"、",(0,i.jsx)(n.code,{children:"vuex"}),"、",(0,i.jsx)(n.code,{children:"sentry"}),"、",(0,i.jsx)(n.code,{children:"axios"}),"、",(0,i.jsx)(n.code,{children:"redux"}),"、",(0,i.jsx)(n.code,{children:"koa"}),"、",(0,i.jsx)(n.code,{children:"vue-devtools"}),"、",(0,i.jsx)(n.code,{children:"vuex4"}),"、",(0,i.jsx)(n.code,{children:"koa-compose"}),"、",(0,i.jsx)(n.code,{children:"vue 3.2 发布"}),"、",(0,i.jsx)(n.code,{children:"vue-this"}),"、",(0,i.jsx)(n.code,{children:"create-vue"}),"、",(0,i.jsx)(n.code,{children:"玩具vite"}),"、",(0,i.jsx)(n.code,{children:"create-vite"})," 等20余篇源码文章。"]})]})}function a(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:n}=Object.assign({},(0,s.ah)(),e.components);return n?(0,i.jsx)(n,Object.assign({},e,{children:(0,i.jsx)(t,e)})):t(e)}let o=a;a.__RSPRESS_PAGE_META={},a.__RSPRESS_PAGE_META["mini-ci%2Findex.md"]={toc:[{id:"1-前言",text:"1. 前言",depth:2},{id:"2-前情回顾",text:"2. 前情回顾",depth:2},{id:"3-关于为啥要开发这样的工具",text:"3. 关于为啥要开发这样的工具",depth:2},{id:"4-miniprogram-ci-官方文档",text:"4. miniprogram-ci 官方文档",depth:2},{id:"41-上传",text:"4.1 上传",depth:3},{id:"42-预览",text:"4.2 预览",depth:3},{id:"5-taro-小程序插件-tarojsplugin-mini-ci",text:"5. Taro 小程序插件 @tarojs/plugin-mini-ci",depth:2},{id:"6-uni-app-好像没有提供类似的插件",text:"6. uni-app 好像没有提供类似的插件",depth:2},{id:"7-release-it-自动提升版本打-tag生成-changelog-等",text:"7. release-it 自动提升版本、打 tag、生成 changelog 等",depth:2},{id:"71-npm-init-release-it-原理",text:"7.1 npm init release-it 原理",depth:3},{id:"8-小程序上传工具实现主流程",text:"8. 小程序上传工具实现主流程",depth:2},{id:"81-添加功能支持指定参数",text:"8.1 添加功能支持指定参数",depth:3},{id:"82-支持读取项目的packagejson-的version也支持读取自定义version",text:"8.2 支持读取项目的`package.json` 的`version`，也支持读取自定义`version`",depth:3},{id:"83-版本描述-支持指定-git-commit-hash-和作者",text:"8.3 版本描述 支持指定 git commit hash 和作者",depth:3},{id:"84-读取配置-wxconfigjs-配置更推荐",text:"8.4 读取配置 wx.config.js 配置（更推荐）",depth:3},{id:"85-支持选择多个小程序",text:"8.5 支持选择多个小程序",depth:3},{id:"86-支持多个批量上传",text:"8.6 支持多个批量上传",depth:3},{id:"87-更多如何使用可以参考文档",text:"8.7 更多如何使用可以参考文档",depth:3},{id:"9-总结",text:"9. 总结",depth:2}],title:"还在用开发者工具上传小程序? 快来试试 miniprogram-ci 提效摸鱼",headingTitle:"还在用开发者工具上传小程序? 快来试试 miniprogram-ci 提效摸鱼",frontmatter:{highlight:"darcula",theme:"smartblue"}}},20713:function(e,n,r){r.d(n,{Z:()=>o});var i=r(52676),s=r(75271),c=r(92815);r(18544);let t={"zh-CN":e=>`\u{9884}\u{8BA1}\u{9605}\u{8BFB}\u{65F6}\u{95F4}: ${e.minutes>=1?`${Math.ceil(e.minutes)} \u{5206}\u{949F}`:"小于 1 分钟"}`,"en-US":e=>`Estimated reading time: ${e.minutes>=1?`${Math.ceil(e.minutes)} minutes`:"less than 1 minute"}`};function a(e,n,r){let i=Object.keys(t).includes(n)?n:r;return t[i](e)}let o=e=>{let{defaultLocale:n="en-US"}=e,r=(0,c.Vi)().page.readingTimeData,t=(0,c.Jr)(),o=(0,c.e7)(),[l,h]=(0,s.useState)(a(r,t,n));return(0,s.useEffect)(()=>{h(a(r,t,n))},[t,r]),(0,i.jsx)("span",{"data-dark":String(o),className:"rp-reading-time",children:l})}}}]);