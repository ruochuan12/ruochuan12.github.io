"use strict";(self.webpackChunkblog=self.webpackChunkblog||[]).push([["3"],{26996:function(e,n,r){r.r(n),r.d(n,{default:()=>i});var s=r(52676),c=r(40453),o=r(20713);function t(e){let n=Object.assign({h1:"h1",a:"a",h2:"h2",blockquote:"blockquote",p:"p",strong:"strong",code:"code",pre:"pre",ol:"ol",li:"li"},(0,c.ah)(),e.components);return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)(n.h1,{id:"面试官项目中常用的-env-文件原理是什么如何实现",children:[(0,s.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#面试官项目中常用的-env-文件原理是什么如何实现",children:"#"}),"面试官：项目中常用的 .env 文件原理是什么？如何实现？"]}),"\n",(0,s.jsx)(o.Z,{defaultLocale:"zh-CN"}),"\n",(0,s.jsxs)(n.h2,{id:"1-前言",children:[(0,s.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#1-前言",children:"#"}),"1. 前言"]}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsxs)(n.p,{children:["大家好，我是",(0,s.jsx)(n.a,{href:"https://ruochuan12.github.io",rel:"noopener noreferrer",target:"_blank",children:"若川"}),"。",(0,s.jsx)(n.a,{href:"https://www.yuque.com/docs/share/9492e1e0-3499-47df-954d-b3f14487e9de",rel:"noopener noreferrer",target:"_blank",children:"正在参加掘金年度人气作者活动，可以点此帮我投票"}),"。",(0,s.jsx)(n.strong,{children:"为了能帮助到更多对源码感兴趣、想学会看源码、提升自己前端技术能力的同学"}),"。我倾力组织了",(0,s.jsx)(n.a,{href:"https://juejin.cn/post/7079706017579139102",rel:"noopener noreferrer",target:"_blank",children:"源码共读活动"}),"，感兴趣的可以加我微信 ",(0,s.jsx)(n.a,{href:"https://juejin.cn/pin/7005372623400435725",rel:"noopener noreferrer",target:"_blank",children:"ruochuan12"})," 参与。每周大家一起学习200行左右的源码，已进行5个月。"]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["想学源码，极力推荐关注我写的专栏（目前2K人关注）",(0,s.jsx)(n.a,{href:"https://juejin.cn/column/6960551178908205093",rel:"noopener noreferrer",target:"_blank",children:"《学习源码整体架构系列》"})," 包含",(0,s.jsx)(n.code,{children:"jQuery"}),"、",(0,s.jsx)(n.code,{children:"underscore"}),"、",(0,s.jsx)(n.code,{children:"lodash"}),"、",(0,s.jsx)(n.code,{children:"vuex"}),"、",(0,s.jsx)(n.code,{children:"sentry"}),"、",(0,s.jsx)(n.code,{children:"axios"}),"、",(0,s.jsx)(n.code,{children:"redux"}),"、",(0,s.jsx)(n.code,{children:"koa"}),"、",(0,s.jsx)(n.code,{children:"vue-devtools"}),"、",(0,s.jsx)(n.code,{children:"vuex4"}),"、",(0,s.jsx)(n.code,{children:"koa-compose"}),"、",(0,s.jsx)(n.code,{children:"vue 3.2 发布"}),"、",(0,s.jsx)(n.code,{children:"vue-this"}),"、",(0,s.jsx)(n.code,{children:"create-vue"}),"、",(0,s.jsx)(n.code,{children:"玩具vite"}),"等20余篇源码文章。"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.a,{href:"https://github.com/ruochuan12/dotenv-analysis.git",rel:"noopener noreferrer",target:"_blank",children:"本文仓库 https://github.com/ruochuan12/dotenv-analysis.git，求个star^_^"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.a,{href:"https://juejin.cn/post/7079706017579139102",rel:"noopener noreferrer",target:"_blank",children:"源码共读活动"})," 每周一期，已进行到18期。于是搜寻各种值得我们学习，且代码行数不多的源码。",(0,s.jsx)(n.a,{href:"https://github.com/motdotla/dotenv/blob/master/lib/main.js",rel:"noopener noreferrer",target:"_blank",children:"dotenv 主文件仅118行"}),"，非常值得我们学习。"]}),"\n",(0,s.jsx)(n.p,{children:"阅读本文，你将学到："}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"1. 学会 dotenv 原理和实现\n2. 学会使用 fs模块 获取文件并解析\n3. 等等\n"})}),"\n",(0,s.jsxs)(n.h2,{id:"2-环境准备",children:[(0,s.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#2-环境准备",children:"#"}),"2. 环境准备"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"# 推荐克隆我的项目，保证与文章同步\ngit clone https://github.com/ruochuan12/dotenv-analysis.git\n# npm i -g yarn\ncd dotenv-analysis/dotenv && yarn i\n# VSCode 直接打开当前项目\n# code .\n# 我写的例子都在 examples 这个文件夹中，可以启动服务本地查看调试\n# 在 dotenv-analysis 目录下\nnode examples/index.js\n\n# 或者克隆官方项目\ngit clone https://github.com/motdotla/dotenv.git\n# npm i -g yarn\ncd dotenv && yarn i\n# VSCode 直接打开当前项目\n# code .\n"})}),"\n",(0,s.jsxs)(n.p,{children:["如果需要对源码进行调试，可以看我的这篇文章：",(0,s.jsx)(n.a,{href:"https://juejin.cn/post/7030584939020042254",rel:"noopener noreferrer",target:"_blank",children:"新手向：前端程序员必学基本技能——调试JS代码"}),"，这里就不再赘述了。"]}),"\n",(0,s.jsxs)(n.h2,{id:"3-dotenv-的作用",children:[(0,s.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#3-dotenv-的作用",children:"#"}),"3. dotenv 的作用"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.a,{href:"https://github.com/motdotla/dotenv",rel:"noopener noreferrer",target:"_blank",children:"dotenv"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"Dotenv"})," 是一个零依赖模块，可将 ",(0,s.jsx)(n.code,{children:".env"})," 文件中的环境变量加载到 ",(0,s.jsx)(n.code,{children:"process.env"})," 中。"]}),"\n",(0,s.jsx)(n.p,{children:"如果需要使用变量，则配合如下扩展包使用。"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.a,{href:"https://github.com/motdotla/dotenv-expand",rel:"noopener noreferrer",target:"_blank",children:"dotenv-expand"})}),"\n",(0,s.jsxs)(n.p,{children:["众所周知，",(0,s.jsx)(n.code,{children:".env"})," 文件在我们项目中非常常见，在 ",(0,s.jsx)(n.code,{children:"vue-cli"})," 和 ",(0,s.jsx)(n.code,{children:"create-react-app"})," 中都有使用。"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.a,{href:"https://cli.vuejs.org/zh/guide/mode-and-env.html#%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F",rel:"noopener noreferrer",target:"_blank",children:"vue-cli .env"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.a,{href:"https://create-react-app.dev/docs/adding-custom-environment-variables/#what-other-env-files-can-be-used",rel:"noopener noreferrer",target:"_blank",children:"create-react-app .env"})}),"\n",(0,s.jsxs)(n.h2,{id:"4-env-文件使用",children:[(0,s.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#4-env-文件使用",children:"#"}),"4. .env 文件使用"]}),"\n",(0,s.jsxs)(n.p,{children:["我们项目中经常会用到",(0,s.jsx)(n.code,{children:".env 文件"}),"写法："]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"NAME=若川\nAGE=18\nBLOG=https://ruochuan12.github.io\nMP_WEIXIN='若川视野'\nACTIVITY=每周一起学200行左右的源码共读活动\nWEIXIN=加我微信 ruochuan12 参与\n"})}),"\n",(0,s.jsx)(n.p,{children:"单从这个文件来看，我们可以知道有如下功能需要实现："}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"读取 .env 文件"}),"\n",(0,s.jsx)(n.li,{children:"解析 .env 文件拆成键值对的对象形式"}),"\n",(0,s.jsx)(n.li,{children:"赋值到 process.env 上"}),"\n",(0,s.jsx)(n.li,{children:"最后返回解析后得到的对象"}),"\n"]}),"\n",(0,s.jsxs)(n.h2,{id:"5-简单实现",children:[(0,s.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#5-简单实现",children:"#"}),"5. 简单实现"]}),"\n",(0,s.jsx)(n.p,{children:"根据分析问题，我们最终可以简单把代码实现如下："}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-js",children:"const fs = require('fs');\nconst path = require('path');\n\nconst parse = function parse(src){\n    const obj = {};\n    // 用换行符 分割\n    // 比如\n    /**\n     * NAME=若川\n     * AGE=18\n     * MP_WEIXIN=若川视野\n     * BLOG=https://ruochuan12.github.io\n     * ACTIVITY=每周一起学200行左右的源码共读活动\n     * WEIXIN=加我微信 ruochuan12 参与\n    */\n    src.toString().split('\\n').forEach(function(line, index){\n        // 用等号分割\n        const keyValueArr = line.split('=');\n        // NAME\n        key = keyValueArr[0];\n        // 若川\n        val = keyValueArr[1] || '';\n        obj[key] = val;\n    });\n    // { NAME: '若川', ... }\n    return obj;\n}\n\nconst config = function(){\n    // 读取 node 执行的当前路径下的 .env 文件\n    let dotenvPath = path.resolve(process.cwd(), '.env');\n    // 按 utf-8 解析文件，得到对象\n    // { NAME: '若川', ... }\n    const parsed = parse(fs.readFileSync(dotenvPath, 'utf-8'));\n\n    // 键值对形式赋值到 process.env 变量上，原先存在的不赋值\n    Object.keys(parsed).forEach(function(key){\n        if(!Object.prototype.hasOwnProperty.call(process.env, key)){\n            process.env[key] = parsed[key];\n        }\n    });\n\n    // 返回对象\n    return parsed;\n};\n\nconsole.log(config());\nconsole.log(process.env);\n\n// 导出 config parse 函数\nmodule.exports.config = config;\nmodule.exports.parse = parse;\n"})}),"\n",(0,s.jsxs)(n.h2,{id:"6-继续完善-config-函数",children:[(0,s.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#6-继续完善-config-函数",children:"#"}),"6. 继续完善 config 函数"]}),"\n",(0,s.jsx)(n.p,{children:"简版的 config 函数还缺失挺多功能，比如："}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"可由用户自定义路径\n可由用户自定义解析编码规则\n添加 debug 模式\n完善报错输出，用户写的 env 文件自由度比较大，所以需要容错机制。\n"})}),"\n",(0,s.jsx)(n.p,{children:"根据功能，我们很容易实现以下代码："}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-js",children:"function resolveHome (envPath) {\n    return envPath[0] === '~' ? path.join(os.homedir(), envPath.slice(1)) : envPath\n}\n\nconst config = function(options){\n    // 读取 node 执行的当前路径下的 .env 文件\n    let dotenvPath = path.resolve(process.cwd(), '.env');\n    // utf8\n    let encoding = 'utf8';\n    // debug 模式，输出提示等信息\n    let debug = false;\n    // 对象\n    if (options) {\n        if (options.path != null) {\n            // 解析路径\n            dotenvPath = resolveHome(options.path)\n        }\n        // 使用配置的编码方式\n        if (options.encoding != null) {\n            encoding = options.encoding\n        }\n        // 有配置就设置为 true\n        if (options.debug != null) {\n            debug = true\n        }\n    }\n\n    try {\n        // 按 utf-8 解析文件，得到对象\n        // { NAME: '若川', ... }\n        // debug 传递给 parse 函数 便于\n        const parsed = parse(fs.readFileSync(dotenvPath, { encoding }), { debug });\n\n        // 键值对形式赋值到 process.env 变量上，原先存在的不赋值\n        Object.keys(parsed).forEach(function(key){\n            if(!Object.prototype.hasOwnProperty.call(process.env, key)){\n                process.env[key] = parsed[key];\n            } else if (debug) {\n                console.log(`\"${key}\" is already defined in \\`process.env\\` and will not be overwritten`);\n            }\n        });\n\n        // 返回对象\n        return parsed;\n    }\n    catch (e) {\n        return { error: e };\n    }\n};\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"dotenv"})," 源码中，",(0,s.jsx)(n.code,{children:"parse"})," 函数主要是一些正则和单双引号、跨平台等细致处理。这里就暂时不阐述，读者朋友可以查看",(0,s.jsx)(n.a,{href:"https://github.com/motdotla/dotenv/blob/master/lib/main.js",rel:"noopener noreferrer",target:"_blank",children:"dotenv 源码"}),"。"]}),"\n",(0,s.jsxs)(n.h2,{id:"7-总结",children:[(0,s.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#7-总结",children:"#"}),"7. 总结"]}),"\n",(0,s.jsxs)(n.p,{children:["鉴于文章不宜过长，文章只比较深入的分析了 ",(0,s.jsx)(n.code,{children:"config"})," 函数。",(0,s.jsx)(n.code,{children:"parse"})," 函数目前没有深入分析。"]}),"\n",(0,s.jsxs)(n.p,{children:["一句话总结 ",(0,s.jsx)(n.code,{children:"dotenv"})," 库的原理。",(0,s.jsxs)(n.strong,{children:["用 ",(0,s.jsx)(n.code,{children:"fs.readFileSync"})," 读取 ",(0,s.jsx)(n.code,{children:".env"})," 文件，并解析文件为键值对形式的对象，将最终结果对象遍历赋值到 ",(0,s.jsx)(n.code,{children:"process.env"})," 上"]}),"。"]}),"\n",(0,s.jsxs)(n.p,{children:["我们也可以不看 ",(0,s.jsx)(n.code,{children:"dotenv"})," 源码，根据 ",(0,s.jsx)(n.code,{children:"api"})," 倒推，自己来实现这样的功能。最终看看和  ",(0,s.jsx)(n.code,{children:"dotenv"})," 源码本身有什么差别。这样也许更能锻炼自己。或者用 ",(0,s.jsx)(n.code,{children:"ts"})," 重构它。"]}),"\n",(0,s.jsxs)(n.p,{children:["本文同时也给我们启发：围绕工作常用的技术包和库值得深入学习，做到",(0,s.jsx)(n.strong,{children:"知其然，知其所以然"}),"。"]}),"\n",(0,s.jsxs)(n.p,{children:["值得一提的是：",(0,s.jsx)(n.code,{children:"dotenv"})," 源码使用的是 ",(0,s.jsx)(n.code,{children:"flow"})," 类型。vue2 源码也是用的 ",(0,s.jsx)(n.code,{children:"flow"}),"。vue3 源码改用 ",(0,s.jsx)(n.code,{children:"ts"}),"了。"]}),"\n",(0,s.jsxs)(n.p,{children:["最后可以持续关注我@若川。欢迎加我微信 ",(0,s.jsx)(n.a,{href:"https://juejin.cn/pin/7005372623400435725",rel:"noopener noreferrer",target:"_blank",children:"ruochuan12"})," 交流，参与 ",(0,s.jsx)(n.a,{href:"https://juejin.cn/pin/7005372623400435725",rel:"noopener noreferrer",target:"_blank",children:"源码共读"})," 活动，每周大家一起学习200行左右的源码，共同进步。"]})]})}function d(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:n}=Object.assign({},(0,c.ah)(),e.components);return n?(0,s.jsx)(n,Object.assign({},e,{children:(0,s.jsx)(t,e)})):t(e)}let i=d;d.__RSPRESS_PAGE_META={},d.__RSPRESS_PAGE_META["dotenv%2Findex.md"]={toc:[{id:"1-前言",text:"1. 前言",depth:2},{id:"2-环境准备",text:"2. 环境准备",depth:2},{id:"3-dotenv-的作用",text:"3. dotenv 的作用",depth:2},{id:"4-env-文件使用",text:"4. .env 文件使用",depth:2},{id:"5-简单实现",text:"5. 简单实现",depth:2},{id:"6-继续完善-config-函数",text:"6. 继续完善 config 函数",depth:2},{id:"7-总结",text:"7. 总结",depth:2}],title:"面试官：项目中常用的 .env 文件原理是什么？如何实现？",headingTitle:"面试官：项目中常用的 .env 文件原理是什么？如何实现？",frontmatter:{highlight:"darcula",theme:"smartblue"}}},20713:function(e,n,r){r.d(n,{Z:()=>i});var s=r(52676),c=r(75271),o=r(92815);r(18544);let t={"zh-CN":e=>`\u{9884}\u{8BA1}\u{9605}\u{8BFB}\u{65F6}\u{95F4}: ${e.minutes>=1?`${Math.ceil(e.minutes)} \u{5206}\u{949F}`:"小于 1 分钟"}`,"en-US":e=>`Estimated reading time: ${e.minutes>=1?`${Math.ceil(e.minutes)} minutes`:"less than 1 minute"}`};function d(e,n,r){let s=Object.keys(t).includes(n)?n:r;return t[s](e)}let i=e=>{let{defaultLocale:n="en-US"}=e,r=(0,o.Vi)().page.readingTimeData,t=(0,o.Jr)(),i=(0,o.e7)(),[a,l]=(0,c.useState)(d(r,t,n));return(0,c.useEffect)(()=>{l(d(r,t,n))},[t,r]),(0,s.jsx)("span",{"data-dark":String(i),className:"rp-reading-time",children:a})}}}]);