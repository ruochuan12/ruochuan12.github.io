"use strict";(self.webpackChunkblog=self.webpackChunkblog||[]).push([["7050"],{45829:function(e,n,r){r.r(n),r.d(n,{default:()=>c});var s=r(52676),a=r(40453),t=r(20713);function i(e){let n=Object.assign({h1:"h1",a:"a",h2:"h2",blockquote:"blockquote",p:"p",strong:"strong",code:"code",pre:"pre",h3:"h3"},(0,a.ah)(),e.components);return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)(n.h1,{id:"vue团队核心成员开发的39行小工具-install-pkg-安装包值得一学",children:[(0,s.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#vue团队核心成员开发的39行小工具-install-pkg-安装包值得一学",children:"#"}),"Vue团队核心成员开发的39行小工具 install-pkg 安装包，值得一学！"]}),"\n",(0,s.jsx)(t.Z,{defaultLocale:"zh-CN"}),"\n",(0,s.jsxs)(n.h2,{id:"1-前言",children:[(0,s.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#1-前言",children:"#"}),"1. 前言"]}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsxs)(n.p,{children:["大家好，我是",(0,s.jsx)(n.a,{href:"https://ruochuan12.github.io",rel:"noopener noreferrer",target:"_blank",children:"若川"}),"。",(0,s.jsx)(n.strong,{children:"为了能帮助到更多对源码感兴趣、想学会看源码、提升自己前端技术能力的同学"}),"。我倾力组织了",(0,s.jsx)(n.a,{href:"https://juejin.cn/post/7079706017579139102",rel:"noopener noreferrer",target:"_blank",children:"源码共读活动"}),"，感兴趣的可以加我微信 ",(0,s.jsx)(n.a,{href:"https://juejin.cn/pin/7005372623400435725",rel:"noopener noreferrer",target:"_blank",children:"ruochuan12"})," 参与，欢迎关注我的",(0,s.jsx)(n.a,{href:"https://ruochuan12.github.io",rel:"noopener noreferrer",target:"_blank",children:"公众号若川视野"}),"。每周大家一起学习200行左右的源码，共同进步，已进行4个月，很多人都表示收获颇丰。"]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["想学源码，极力推荐关注我写的专栏（目前1.9K人关注）",(0,s.jsx)(n.a,{href:"https://juejin.cn/column/6960551178908205093",rel:"noopener noreferrer",target:"_blank",children:"《学习源码整体架构系列》"})," 包含",(0,s.jsx)(n.code,{children:"jQuery"}),"、",(0,s.jsx)(n.code,{children:"underscore"}),"、",(0,s.jsx)(n.code,{children:"lodash"}),"、",(0,s.jsx)(n.code,{children:"vuex"}),"、",(0,s.jsx)(n.code,{children:"sentry"}),"、",(0,s.jsx)(n.code,{children:"axios"}),"、",(0,s.jsx)(n.code,{children:"redux"}),"、",(0,s.jsx)(n.code,{children:"koa"}),"、",(0,s.jsx)(n.code,{children:"vue-devtools"}),"、",(0,s.jsx)(n.code,{children:"vuex4"}),"、",(0,s.jsx)(n.code,{children:"koa-compose"}),"、",(0,s.jsx)(n.code,{children:"vue 3.2 发布"}),"、",(0,s.jsx)(n.code,{children:"vue-this"}),"、",(0,s.jsx)(n.code,{children:"create-vue"}),"、",(0,s.jsx)(n.code,{children:"玩具vite"}),"等20余篇源码文章。"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.a,{href:"https://github.com/ruochuan12/install-pkg-analysis.git",rel:"noopener noreferrer",target:"_blank",children:"本文仓库 https://github.com/ruochuan12/install-pkg-analysis.git，求个star^_^"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.a,{href:"https://juejin.cn/post/7079706017579139102",rel:"noopener noreferrer",target:"_blank",children:"源码共读活动"})," 每周一期，已进行到16期。Vue团队核心成员 ",(0,s.jsx)(n.code,{children:"Anthony Fu"})," 开发的 ",(0,s.jsx)(n.a,{href:"https://github.com/antfu/install-pkg",rel:"noopener noreferrer",target:"_blank",children:"install-pkg"})," 小工具，主文件源码仅39行，非常值得我们学习。"]}),"\n",(0,s.jsx)(n.p,{children:"阅读本文，你将学到："}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"1. 如何学习调试源码\n2. 如何开发构建一个 ts 的 npm 包\n3. 如何配置 github action\n4. 配置属于自己的 eslint 预设、提升版本号等\n5. 学会使用 execa 执行命令\n6. 等等\n"})}),"\n",(0,s.jsxs)(n.h2,{id:"2-install-pkg-是什么",children:[(0,s.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#2-install-pkg-是什么",children:"#"}),"2. install-pkg 是什么"]}),"\n",(0,s.jsxs)(n.p,{children:["Install package programmatically. Detect package managers automatically (",(0,s.jsx)(n.code,{children:"npm"}),", ",(0,s.jsx)(n.code,{children:"yarn"})," and ",(0,s.jsx)(n.code,{children:"pnpm"}),")."]}),"\n",(0,s.jsxs)(n.p,{children:["以编程方式安装包。自动检测包管理器（",(0,s.jsx)(n.code,{children:"npm"}),"、",(0,s.jsx)(n.code,{children:"yarn"})," 和 ",(0,s.jsx)(n.code,{children:"pnpm"}),"）。"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"npm i @antfu/install-pkg\n"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-js",children:"import { installPackage } from '@antfu/install-pkg'\nawait installPackage('vite', { silent: true })\n"})}),"\n",(0,s.jsxs)(n.p,{children:["我们看看",(0,s.jsx)(n.a,{href:"https://www.npmjs.com/package/@antfu/install-pkg",rel:"noopener noreferrer",target:"_blank",children:"npmjs.com @antfu/install-pkg"})," 有哪些包依赖的这个包。"]}),"\n",(0,s.jsx)(n.p,{children:"我们可以发现目前只有以下这两个项目使用了。"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.a,{href:"https://www.npmjs.com/package/unplugin-icons",rel:"noopener noreferrer",target:"_blank",children:"unplugin-icons"}),"\n",(0,s.jsx)(n.a,{href:"https://www.npmjs.com/package/%40chenyueban%2Flint",rel:"noopener noreferrer",target:"_blank",children:"@chenyueban/lint"})]}),"\n",(0,s.jsx)(n.p,{children:"我们克隆项目来看源码。"}),"\n",(0,s.jsxs)(n.h2,{id:"3-克隆项目",children:[(0,s.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#3-克隆项目",children:"#"}),"3 克隆项目"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"# 推荐克隆我的项目，保证与文章同步\ngit clone https://github.com/ruochuan12/install-pkg-analysis.git\n# npm i -g pnpm\ncd install-pkg-analysis/install-pkg && pnpm i\n# VSCode 直接打开当前项目\n# code .\n\n# 或者克隆官方项目\ngit clone https://github.com/antfu/install-pkg.git\n# npm i -g pnpm\ncd install-pkg && pnpm i\n# VSCode 直接打开当前项目\n# code .\n"})}),"\n",(0,s.jsxs)(n.p,{children:["看源码一般先看 ",(0,s.jsx)(n.code,{children:"package.json"}),"，再看 ",(0,s.jsx)(n.code,{children:"script"}),"。"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-js",children:'{\n    "name": "@antfu/install-pkg",\n    "version": "0.1.0",\n    "scripts": {\n      "start": "esno src/index.ts"\n    },\n}\n'})}),"\n",(0,s.jsxs)(n.p,{children:["关于调试可以看我的这篇文章：",(0,s.jsx)(n.a,{href:"https://juejin.cn/post/7030584939020042254",rel:"noopener noreferrer",target:"_blank",children:"新手向：前端程序员必学基本技能——调试JS代码"}),"，这里就不再赘述了。"]}),"\n",(0,s.jsxs)(n.p,{children:["我们可以得知入口文件是 ",(0,s.jsx)(n.code,{children:"src/index.ts"})]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"src"}),"文件夹下有三个文件"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"src\n- detect.ts\n- index.ts\n- install\n"})}),"\n",(0,s.jsx)(n.p,{children:"接着我们看这些文件源码。"}),"\n",(0,s.jsxs)(n.h2,{id:"4-源码",children:[(0,s.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#4-源码",children:"#"}),"4. 源码"]}),"\n",(0,s.jsxs)(n.h3,{id:"41-indexjs",children:[(0,s.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#41-indexjs",children:"#"}),"4.1 index.js"]}),"\n",(0,s.jsx)(n.p,{children:"导出所有"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-js",children:"// src/install.ts\nexport * from './detect'\nexport * from './install'\n"})}),"\n",(0,s.jsxs)(n.p,{children:["我们来看 ",(0,s.jsx)(n.code,{children:"install.ts"})," 文件，",(0,s.jsx)(n.code,{children:"installPackage"})," 方法。"]}),"\n",(0,s.jsxs)(n.h3,{id:"42-installpackage-安装包",children:[(0,s.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#42-installpackage-安装包",children:"#"}),"4.2 installPackage 安装包"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-js",children:"// src/install.ts\nimport execa from 'execa'\nimport { detectPackageManager } from '.'\n\nexport interface InstallPackageOptions {\n  cwd?: string\n  dev?: boolean\n  silent?: boolean\n  packageManager?: string\n  preferOffline?: boolean\n  additionalArgs?: string[]\n}\n\nexport async function installPackage(names: string | string[], options: InstallPackageOptions = {}) {\n  const agent = options.packageManager || await detectPackageManager(options.cwd) || 'npm'\n  if (!Array.isArray(names))\n    names = [names]\n\n  const args = options.additionalArgs || []\n\n  if (options.preferOffline)\n    args.unshift('--prefer-offline')\n\n  return execa(\n    agent,\n    [\n      agent === 'yarn'\n        ? 'add'\n        : 'install',\n      options.dev ? '-D' : '',\n      ...args,\n      ...names,\n    ].filter(Boolean),\n    {\n      stdio: options.silent ? 'ignore' : 'inherit',\n      cwd: options.cwd,\n    },\n  )\n}\n"})}),"\n",(0,s.jsx)(n.p,{children:"支持安装多个，也支持指定包管理器，支持额外的参数。"}),"\n",(0,s.jsxs)(n.p,{children:["其中 ",(0,s.jsx)(n.a,{href:"https://github.com/sindresorhus/execa",rel:"noopener noreferrer",target:"_blank",children:"github execa"})," 是执行脚本"]}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:"Process execution for humans"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"也就是说：最终执行类似以下的脚本。"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"pnpm install -D --prefer-offine release-it react antd\n"})}),"\n",(0,s.jsxs)(n.p,{children:["我们接着来看 ",(0,s.jsx)(n.code,{children:"detect.ts"}),"文件 探测包管理器 ",(0,s.jsx)(n.code,{children:"detectPackageManager"})," 函数如何实现的。"]}),"\n",(0,s.jsxs)(n.h3,{id:"43-detectpackagemanager-探测包管理器",children:[(0,s.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#43-detectpackagemanager-探测包管理器",children:"#"}),"4.3 detectPackageManager 探测包管理器"]}),"\n",(0,s.jsx)(n.p,{children:"根据当前目录锁文件，探测包管理器。"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-js",children:"// src/detect.ts\nimport path from 'path'\nimport findUp from 'find-up'\n\nexport type PackageManager = 'pnpm' | 'yarn' | 'npm'\n\nconst LOCKS: Record<string, PackageManager> = {\n  'pnpm-lock.yaml': 'pnpm',\n  'yarn.lock': 'yarn',\n  'package-lock.json': 'npm',\n}\n\nexport async function detectPackageManager(cwd = process.cwd()) {\n  const result = await findUp(Object.keys(LOCKS), { cwd })\n  const agent = (result ? LOCKS[path.basename(result)] : null)\n  return agent\n}\n"})}),"\n",(0,s.jsxs)(n.p,{children:["其中 ",(0,s.jsx)(n.a,{href:"https://github.com/sindresorhus/find-up#readme",rel:"noopener noreferrer",target:"_blank",children:"find-up"})," 查找路径。"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"/\n└── Users\n    └── install-pkg\n        ├── pnpm-lock.yaml\n"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-js",children:"import {findUp} from 'find-up';\n\nconsole.log(await findUp('pnpm-lock.yaml'));\n//=> '/Users/install-pkg/pnpm-lock.yaml'\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"path.basename('/Users/install-pkg/pnpm-lock.yaml')"})," 则是 ",(0,s.jsx)(n.code,{children:"pnpm-lock.yaml"}),"。"]}),"\n",(0,s.jsxs)(n.p,{children:["所以在有",(0,s.jsx)(n.code,{children:"pnpm-lock.yaml"}),"文件的项目中，",(0,s.jsx)(n.code,{children:"detectPackageManager"})," 函数最终返回的是 ",(0,s.jsx)(n.code,{children:"pnpm"}),"。"]}),"\n",(0,s.jsxs)(n.p,{children:["至此我们可以用一句话总结原理就是：通过锁文件自动检测使用何种包管理器（npm、yarn、pnpm），最终用 ",(0,s.jsx)(n.a,{href:"https://github.com/sindresorhus/execa",rel:"noopener noreferrer",target:"_blank",children:"execa"})," 执行类似如下的命令。"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"pnpm install -D --prefer-offine release-it react antd\n"})}),"\n",(0,s.jsxs)(n.p,{children:["看完源码，我们接着来解释下 ",(0,s.jsx)(n.code,{children:"package.json"})," 中的 ",(0,s.jsx)(n.code,{children:"scripts"})," 命令。"]}),"\n",(0,s.jsxs)(n.h2,{id:"5-packagejson-script-命令解析",children:[(0,s.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#5-packagejson-script-命令解析",children:"#"}),"5. package.json script 命令解析"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-js",children:'{\n    "name": "@antfu/install-pkg",\n    "version": "0.1.0",\n    "scripts": {\n      "prepublishOnly": "nr build",\n      "dev": "nr build --watch",\n      "start": "esno src/index.ts",\n      "build": "tsup src/index.ts --format cjs,esm --dts --no-splitting",\n      "release": "bumpp --commit --push --tag && pnpm publish",\n      "lint": "eslint \\"{src,test}/**/*.ts\\"",\n      "lint:fix": "nr lint -- --fix"\n    },\n}\n'})}),"\n",(0,s.jsxs)(n.h3,{id:"51-ni-神器",children:[(0,s.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#51-ni-神器",children:"#"}),"5.1 ni 神器"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.a,{href:"https://github.com/antfu/ni",rel:"noopener noreferrer",target:"_blank",children:"github ni"})}),"\n",(0,s.jsx)(n.p,{children:"我之前写过源码文章。"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.a,{href:"https://juejin.cn/post/7023910122770399269",rel:"noopener noreferrer",target:"_blank",children:"尤雨溪推荐神器 ni ，能替代 npm/yarn/pnpm ？简单好用！源码揭秘！"})}),"\n",(0,s.jsx)(n.p,{children:"自动根据锁文件 yarn.lock / pnpm-lock.yaml / package-lock.json 检测使用 yarn / pnpm / npm 的包管理器。"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"nr dev --port=3000\n\n# npm run dev -- --port=3000\n# yarn run dev --port=3000\n# pnpm run dev -- --port=3000\n"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"nr\n# 交互式选择脚本\n# interactively select the script to run\n# supports https://www.npmjs.com/package/npm-scripts-info convention\n"})}),"\n",(0,s.jsx)(n.p,{children:"nci - clean install"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"nci\n# npm ci\n# 简单说就是不更新锁文件\n# yarn install --frozen-lockfile\n# pnpm install --frozen-lockfile\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.a,{href:"https://pnpm.io/zh/cli/install#--frozen-lockfile",rel:"noopener noreferrer",target:"_blank",children:"pnpm install --frozen-lockfile"})}),"\n",(0,s.jsxs)(n.h3,{id:"52-esno-运行-ts",children:[(0,s.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#52-esno-运行-ts",children:"#"}),"5.2 esno 运行 ts"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.a,{href:"https://github.com/antfu/esno#readme",rel:"noopener noreferrer",target:"_blank",children:"esno"})}),"\n",(0,s.jsx)(n.p,{children:"TypeScript / ESNext node runtime powered by esbuild"}),"\n",(0,s.jsx)(n.p,{children:"源码也不是很多。"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-js",children:"#!/usr/bin/env node\n\nconst spawn = require('cross-spawn')\nconst spawnSync = spawn.sync\n\nconst register = require.resolve('esbuild-register')\n\nconst argv = process.argv.slice(2)\n\nprocess.exit(spawnSync('node', ['-r', register, ...argv], { stdio: 'inherit' }).status)\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.a,{href:"https://github.com/egoist/esbuild-register",rel:"noopener noreferrer",target:"_blank",children:"esbuild-register"}),"\n简单说：使用 esbuild 即时传输 JSX、TypeScript 和 esnext 功能"]}),"\n",(0,s.jsxs)(n.h3,{id:"53-tsup-打包-ts",children:[(0,s.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#53-tsup-打包-ts",children:"#"}),"5.3 tsup 打包 ts"]}),"\n",(0,s.jsxs)(n.p,{children:["打包 ",(0,s.jsx)(n.code,{children:"TypeScript"})," 库的最简单、最快的方法。"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.a,{href:"https://github.com/egoist/tsup#readme",rel:"noopener noreferrer",target:"_blank",children:"tsup"})}),"\n",(0,s.jsxs)(n.h3,{id:"54-bumpp-交互式提升版本号",children:[(0,s.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#54-bumpp-交互式提升版本号",children:"#"}),"5.4 bumpp 交互式提升版本号"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.a,{href:"https://github.com/antfu/bumpp",rel:"noopener noreferrer",target:"_blank",children:"bumpp"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.a,{href:"https://github.com/JS-DevTools/version-bump-prompt",rel:"noopener noreferrer",target:"_blank",children:"version-bump-prompt"})}),"\n",(0,s.jsx)(n.p,{children:"交互式 CLI 可增加您的版本号等"}),"\n",(0,s.jsxs)(n.h3,{id:"55-eslint-预设",children:[(0,s.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#55-eslint-预设",children:"#"}),"5.5 eslint 预设"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.a,{href:"https://github.com/antfu/eslint-config",rel:"noopener noreferrer",target:"_blank",children:"eslint 预设"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-js",children:"pnpm add -D eslint @antfu/eslint-config\n"})}),"\n",(0,s.jsxs)(n.p,{children:["添加 ",(0,s.jsx)(n.code,{children:".eslintrc"})," 文件"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-js",children:'// .eslintrc\n{\n  "extends": ["@antfu"],\n  "rules": {}\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:"之前看其他源码发现的也很好用的 eslint 工具 xo"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.a,{href:"https://github.com/xojs/xo",rel:"noopener noreferrer",target:"_blank",children:"xo"})}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:"JavaScript/TypeScript linter (ESLint wrapper) with great defaults\nJavaScript/TypeScript linter（ESLint 包装器）具有很好的默认值"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"看完 scripts 命令解析，我们来看看 github action 配置。"}),"\n",(0,s.jsxs)(n.h2,{id:"6-github-action-workflows",children:[(0,s.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#6-github-action-workflows",children:"#"}),"6. github action workflows"]}),"\n",(0,s.jsxs)(n.p,{children:["对于github action 不熟悉的读者，可以看",(0,s.jsx)(n.a,{href:"https://www.ruanyifeng.com/blog/2019/09/getting-started-with-github-actions.html",rel:"noopener noreferrer",target:"_blank",children:"阮一峰老师 GitHub Actions 入门教程"})]}),"\n",(0,s.jsxs)(n.p,{children:["配置文件",(0,s.jsx)(n.a,{href:"https://github.com/antfu/install-pkg/blob/main/.github/workflows/release.yml",rel:"noopener noreferrer",target:"_blank",children:"workflows/release"})]}),"\n",(0,s.jsxs)(n.p,{children:["构建历史",(0,s.jsx)(n.a,{href:"https://github.com/antfu/install-pkg/runs/3773517075?check_suite_focus=true",rel:"noopener noreferrer",target:"_blank",children:"github action workflow"})]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yml",children:"name: Release\n\non:\n  push:\n    tags:\n      - 'v*'\n\njobs:\n  release:\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/checkout@v2\n        with:\n          fetch-depth: 0\n      - uses: actions/setup-node@v2\n        with:\n          node-version: '14'\n          registry-url: https://registry.npmjs.org/\n      - run: npm i -g pnpm @antfu/ni\n      - run: nci\n      - run: nr test --if-present\n      - run: npx conventional-github-releaser -p angular\n        env:\n          CONVENTIONAL_GITHUB_RELEASER_TOKEN: ${{secrets.GITHUB_TOKEN}}\n"})}),"\n",(0,s.jsx)(n.p,{children:"根据每次 tags 推送，执行。"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"# 全局安装 pnpm 和 ni\nnpm i -g pnpm @antfu/ni\n"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"# 如何存在 test 命令则执行\nnr test --if-present\n"})}),"\n",(0,s.jsx)(n.p,{children:"nci - clean install"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"nci\n# npm ci\n# 简单说就是不更新锁文件\n# yarn install --frozen-lockfile\n# pnpm install --frozen-lockfile\n"})}),"\n",(0,s.jsxs)(n.p,{children:["最后 ",(0,s.jsx)(n.code,{children:"npx conventional-github-releaser -p angular"}),"\n",(0,s.jsx)(n.a,{href:"https://www.npmjs.com/package/conventional-github-releaser",rel:"noopener noreferrer",target:"_blank",children:"conventional-github-releaser"})]}),"\n",(0,s.jsxs)(n.p,{children:["生成 ",(0,s.jsx)(n.code,{children:"changelog"}),"。"]}),"\n",(0,s.jsxs)(n.p,{children:["至此我们就学习完了 ",(0,s.jsx)(n.a,{href:"https://github.com/antfu/install-pkg",rel:"noopener noreferrer",target:"_blank",children:"install-pkg"})," 包。"]}),"\n",(0,s.jsxs)(n.h2,{id:"7-总结",children:[(0,s.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#7-总结",children:"#"}),"7. 总结"]}),"\n",(0,s.jsxs)(n.p,{children:["整体代码比较简单。原理就是通过锁文件自动检测使用何种包管理器（npm、yarn、pnpm），最终用 ",(0,s.jsx)(n.a,{href:"https://github.com/sindresorhus/execa",rel:"noopener noreferrer",target:"_blank",children:"execa"})," 执行类似如下的命令。"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"pnpm install -D --prefer-offine release-it react antd\n"})}),"\n",(0,s.jsx)(n.p,{children:"我们学到了："}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"1. 如何学习调试源码\n2. 如何开发构建一个 ts 的 npm 包\n3. 如何配置 github action\n4. 配置属于自己的 eslint 预设、提升版本号等\n5. 学会使用 execa 执行命令\n6. 等等\n"})}),"\n",(0,s.jsx)(n.p,{children:"还有各种依赖工具。"}),"\n",(0,s.jsxs)(n.p,{children:["建议读者克隆 ",(0,s.jsx)(n.a,{href:"https://github.com/ruochuan12/install-pkg-analysis.git",rel:"noopener noreferrer",target:"_blank",children:"我的仓库"})," 动手实践调试源码学习。"]}),"\n",(0,s.jsxs)(n.p,{children:["最后可以持续关注我",(0,s.jsx)(n.a,{href:"https://juejin.cn/column/6960551178908205093",rel:"noopener noreferrer",target:"_blank",children:"@若川"}),"。欢迎加我微信 ",(0,s.jsx)(n.a,{href:"https://juejin.cn/pin/7005372623400435725",rel:"noopener noreferrer",target:"_blank",children:"ruochuan12"})," 交流，参与 ",(0,s.jsx)(n.a,{href:"https://juejin.cn/post/7079706017579139102",rel:"noopener noreferrer",target:"_blank",children:"源码共读"})," 活动，每周大家一起学习200行左右的源码，共同进步。"]})]})}function l(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:n}=Object.assign({},(0,a.ah)(),e.components);return n?(0,s.jsx)(n,Object.assign({},e,{children:(0,s.jsx)(i,e)})):i(e)}let c=l;l.__RSPRESS_PAGE_META={},l.__RSPRESS_PAGE_META["install-pkg%2Findex.md"]={toc:[{id:"1-前言",text:"1. 前言",depth:2},{id:"2-install-pkg-是什么",text:"2. install-pkg 是什么",depth:2},{id:"3-克隆项目",text:"3 克隆项目",depth:2},{id:"4-源码",text:"4. 源码",depth:2},{id:"41-indexjs",text:"4.1 index.js",depth:3},{id:"42-installpackage-安装包",text:"4.2 installPackage 安装包",depth:3},{id:"43-detectpackagemanager-探测包管理器",text:"4.3 detectPackageManager 探测包管理器",depth:3},{id:"5-packagejson-script-命令解析",text:"5. package.json script 命令解析",depth:2},{id:"51-ni-神器",text:"5.1 ni 神器",depth:3},{id:"52-esno-运行-ts",text:"5.2 esno 运行 ts",depth:3},{id:"53-tsup-打包-ts",text:"5.3 tsup 打包 ts",depth:3},{id:"54-bumpp-交互式提升版本号",text:"5.4 bumpp 交互式提升版本号",depth:3},{id:"55-eslint-预设",text:"5.5 eslint 预设",depth:3},{id:"6-github-action-workflows",text:"6. github action workflows",depth:2},{id:"7-总结",text:"7. 总结",depth:2}],title:"Vue团队核心成员开发的39行小工具 install-pkg 安装包，值得一学！",headingTitle:"Vue团队核心成员开发的39行小工具 install-pkg 安装包，值得一学！",frontmatter:{highlight:"darcula",theme:"smartblue"}}},20713:function(e,n,r){r.d(n,{Z:()=>c});var s=r(52676),a=r(75271),t=r(92815);r(18544);let i={"zh-CN":e=>`\u{9884}\u{8BA1}\u{9605}\u{8BFB}\u{65F6}\u{95F4}: ${e.minutes>=1?`${Math.ceil(e.minutes)} \u{5206}\u{949F}`:"小于 1 分钟"}`,"en-US":e=>`Estimated reading time: ${e.minutes>=1?`${Math.ceil(e.minutes)} minutes`:"less than 1 minute"}`};function l(e,n,r){let s=Object.keys(i).includes(n)?n:r;return i[s](e)}let c=e=>{let{defaultLocale:n="en-US"}=e,r=(0,t.Vi)().page.readingTimeData,i=(0,t.Jr)(),c=(0,t.e7)(),[h,d]=(0,a.useState)(l(r,i,n));return(0,a.useEffect)(()=>{d(l(r,i,n))},[i,r]),(0,s.jsx)("span",{"data-dark":String(c),className:"rp-reading-time",children:h})}}}]);